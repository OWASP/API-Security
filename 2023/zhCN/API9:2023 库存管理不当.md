API9:2023 资产管理不当
=======================================

| 威胁因素/攻击特征                                            | 安全漏洞                                                     | 影响                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| API相关: 可利用性 3                                          | 普及率**3**: 可检测性 2                                      | 技术2: 业务相关                                              |
| 威胁因素通常通过旧的API版本或未修补的端点获取未授权访问，并使用较弱的安全要求。或者，他们可能通过与没有共享数据原因的第三方获取对敏感数据的访问。 | 过时的文档使查找和/或修补漏洞更加困难。缺乏资产清单和退役策略会导致运行未修补的系统，从而导致敏感数据泄漏。由于现代概念（例如云计算，K8S）使应用程序易于部署和独立，因此通常可以找到不必要暴露的API主机。 | 攻击者可以通过连接到同一数据库的旧未修补的API版本获取对敏感数据甚至服务器的控制权。 |

## API是否易受攻击？

API和现代应用程序的扩散和连接性带来了新的挑战。组织不仅需要了解和了解自己的API和API端点，还需要了解API如何存储或与外部第三方共享数据。

运行多个版本的API需要API提供者提供额外的管理资源，并扩展攻击面。

如果API具有“文档盲区”，例如：

- API主机的目的不清楚，并且没有以下问题的明确答案
  - API运行在哪个环境中（例如生产，暂存，测试，开发）？
  - 谁应该访问API的网络（例如公共，内部，合作伙伴）？
  - 运行哪个API版本？
- 没有文档或现有文档未更新。
- 没有每个API版本的下线计划。
- 站点资产缺失或过时。

在由第三方引起的违规事件时，敏感数据流的可见性和清单起着重要作用。

如果API存在“数据流盲区”，则：

- 存在“敏感数据流”，其中API将敏感数据与第三方共享，且
  - 没有业务理由或批准流程
  - 没有清单或流的可见性
  - 不清楚共享了哪种类型的敏感数据

## 攻击场景举例

### 场景 #1

一家社交网络实施了一个限制频率机制，阻止攻击者使用暴力破解猜测重置密码令牌。这个机制不是作为 API 代码本身的一部分实现的，而是在客户端和官方 API ([www.socialnetwork.com](http://www.socialnetwork.com/)) 之间的一个独立组件中实现的。一位研究人员发现了一个运行相同API的测试版 API 主机 ([www.mbasic.beta.socialnetwork.com](http://www.mbasic.beta.socialnetwork.com/))，包括重置密码机制，但限制频率机制没有实施。研究人员能够通过简单的暴力破解来猜测6位数令牌，重置任何用户的密码。

### 场景 #2

一家社交网络允许独立应用程序的开发人员集成到它的系统中。在此过程中，向最终用户请求同意，以便社交网络可以与独立应用程序共享用户的个人信息。

社交网络与独立应用程序之间的数据流不够严格或受到足够监控，允许独立应用程序访问不仅是用户信息，而且还是他们所有朋友的私人信息。

一家咨询公司开发了一个恶意应用程序，并成功获得了 27 万用户的同意。由于此漏洞，咨询公司成功获取了 5000 万用户的私人信息。后来，咨询公司出售了这些信息，用于恶意目的。

## 如何预防

- 梳理所有<ins>API主机</ins>清单，并记录每个主机的重要信息，着重于API环境（例如生产、暂存、测试、开发）、谁应该具有对主机的网络访问权限（例如公共、内部、合作伙伴）和API版本。
- 梳理所有<ins>集成服务</ins>清单，并记录其在系统中的角色、交换的数据（数据流）以及其敏感性等重要方面。
- 记录 API 的全部信息，例如身份验证、错误、重定向、速率限制、跨源资源共享 (CORS) 策略和端点，包括其参数、请求和响应。
- 通过采用开放标准自动生成文档。将文档生成包含在 CI/CD 管道中。
- 仅向获得使用API授权的人员提供API文档。
- 使用外部保护措施，例如针对所有公开版本的 API 的 API 安全专用解决方案，而不仅仅是当前的生产版本。
- 避免在非生产 API 部署中使用生产数据。如果无法避免，这些端点应该得到与生产端点相同的安全处理。
- 当新版本的API包含安全改进时，执行风险分析以了解对旧版本所需的缓解措施。例如，是否可能将这些改进反向移植而不会破坏API兼容性，或者是否需要迅速将旧版本取出并强制所有客户端移动到最新版本。

## 参考资料

### External

* [CWE-1059: Incomplete Documentation][1]

[1]: https://cwe.mitre.org/data/definitions/1059.html
