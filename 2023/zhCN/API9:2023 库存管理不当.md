API9:2023 库存管理不当
=======================================

| 威胁因素/攻击向量                                            | 安全漏洞                                                     | 影响                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| API特定: Exploitability 3                                    | Prevalence 3: Detectability 2                                | 技术2: 业务特定                                              |
| 威胁因素通常通过旧的API版本或未修补的端点获取未授权访问，并使用较弱的安全要求。或者，他们可能通过与没有共享数据原因的第三方获取对敏感数据的访问。 | 过时的文档使查找和/或修补漏洞更加困难。缺乏资产清单和退役策略会导致运行未修补的系统，从而导致敏感数据泄漏。由于现代概念（例如云计算，K8S）使应用程序易于部署和独立，因此通常可以找到不必要暴露的API主机。 | 攻击者可以通过连接到同一数据库的旧未修补的API版本获取对敏感数据甚至服务器的控制权。 |

## API是否容易受攻击？

API和现代应用程序的扩散和连接性带来了新的挑战。组织不仅需要了解和了解自己的API和API端点，还需要了解API如何存储或与外部第三方共享数据。

运行多个版本的API需要API提供者提供额外的管理资源，并扩展攻击面。

如果API具有“文档盲区”，则：

- API主机的目的不清楚，并且没有以下问题的明确答案
  - API运行在哪个环境中（例如生产，暂存，测试，开发）？
  - 谁应该访问API的网络（例如公共，内部，合作伙伴）？
  - 运行哪个API版本？
- 没有文档或现有文档未更新。
- 没有每个API版本的退役计划。
- 主机库存缺失或过时。

在发生第三方侧的违规事件时，敏感数据流的可见性和清单起着重要作用。

如果API存在“数据流盲区”，则：

- 存在“敏感数据流”，其中API将敏感数据与第三方共享，且
  - 没有业务理由或批准流程
  - 没有清单或流的可见性
  - 不清楚共享了哪种类型的敏感数据

## 攻击场景举例

### 场景 #1

一家社交网络实施了一个限制频率机制，阻止攻击者使用暴力破解猜测重置密码令牌。这个机制不是作为 API 代码本身的一部分实现的，而是在客户端和官方 API ([www.socialnetwork.com](http://www.socialnetwork.com/)) 之间的一个独立组件中实现的。一位研究人员发现了一个运行相同 API 的 beta API 主机 ([www.mbasic.beta.socialnetwork.com)，包括重置密码机制，但限制频率机制没有实施。研究人员能够通过简单的暴力破解来猜测](http://www.mbasic.beta.socialnetwork.xn--com)%2C%2C-1f2mq6vcaa00yt81c8qa582goukyzfp0aea8510a8u7a6rvrx4bj89fhsyafqn.xn--gmq77g6pl6az5ndywp9af70a4wmbjiuneglg4wrzdd91aur6aj6uxkb/) 6 位数令牌，重置任何用户的密码。

### 场景 #2

一家社交网络允许独立应用程序的开发人员集成到它的系统中。在此过程中，向最终用户请求同意，以便社交网络可以与独立应用程序共享用户的个人信息。

社交网络与独立应用程序之间的数据流不够严格或受到足够监控，允许独立应用程序访问不仅是用户信息，而且还是他们所有朋友的私人信息。

一家咨询公司开发了一个恶意应用程序，并成功获得了 27 万用户的同意。由于此漏洞，咨询公司成功获取了 5000 万用户的私人信息。后来，咨询公司出售了这些信息，用于恶意目的。

## 如何预防

- 列出库存所有 API 主机并记录每个主机的重要方面，重点关注 API 环境 (例如生产、暂存、测试、开发)、谁应该访问主机 (例如公共、内部、合作伙伴) 和 API 版本。
- 列出所有库存集成服务并记录其在系统中的角色、交换的数据 (数据流) 和敏感度等重要方面。
- 记录 API 的全部信息，如身份验证、错误、重定向、速率限制、跨源资源共享 (CORS) 策略和端点，包括其参数、请求和响应。
- 通过采用开放标准自动生成文档。将文档生成包含在 CI/CD 管道中。
- 仅向有权使用 API 的人员提供 API 文档。
- 使用外部保护措施，例如针对所有公开版本的 API 的 API 安全专用解决方案，而不仅仅是当前的生产版本。
- 避免在非生产 API 部署中使用生产数据。如果无法避免，这些端点应该得到与生产端点相同的安全处理。

## 参考资料

### External

* [CWE-1059: Incomplete Documentation][1]

[1]: https://cwe.mitre.org/data/definitions/1059.html