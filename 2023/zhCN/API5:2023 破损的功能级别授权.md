API5:2023 损坏的功能级别授权
=============================================

| 威胁来源/攻击特征                                            | 安全弱点                                                     | 影响                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| API相关：可利用性3                                           | 普及率2：可检测性1                                           | 技术2：业务相关                                              |
| 攻击者利用合法的API调用访问不应该访问的API端点。这些端点可能对匿名用户或普通非特权用户开放。由于API更为结构化，访问某些函数的方式更为可预测（例如将HTTP方法从GET更改为PUT，或更改URL中的“用户”字符串为“管理员”），因此在API中发现这些漏洞更为容易。 | 对于功能或资源的授权检查通常是通过配置管理的，有时是在代码级别进行的。实现适当的检查可能是一项困惑的任务，因为现代应用程序可能包含许多类型的角色或组以及复杂的用户层次结构（例如子用户或具有多个角色的用户）。检测依赖于适当的日志记录和监控。 | 此类漏洞允许攻击者访问未经授权的功能。行政功能是此类攻击的主要目标。 |

## API是否易受攻击？

查找损坏的功能级别授权问题的最佳方法是对授权机制进行深入分析，同时考虑用户层次结构、应用程序中的不同角色或组，并提出以下问题：

- 普通用户是否可以访问行政端点？
- 用户是否可以通过更改HTTP方法（例如从GET更改为DELETE）来执行他们不应该访问的敏感操作（例如创建、修改或删除）？
- 是否可以猜测端点URL和参数（例如`/api/v1/users/export_all`）并让X组的用户访问应仅向Y组的用户公开的功能？

不要基于URL路径假设API端点是常规的或行政的。

虽然开发人员可能选择将大多数行政端点公开在特定的相对路径下，例如`/api/admins`，但通常还可以找到这些行政端点与常规端点一起位于其他相对路径下，例如`/api/users`。

## 攻击场景举例

### 场景 #1

某个只允许受邀用户加入的应用在注册过程中，移动应用程序触发一个API调用， 调用 `GET /api/invites/{invite_guid}` 接口。响应中包含有关邀请的详细信息， 包括用户的角色和电子邮件。

攻击者复制请求并操作HTTP方法和端点，将其更改为 `POST /api/invites/new`。 该端点只应由使用管理控制台的管理员访问。该端点未实现功能级授权检查。

攻击者利用这个问题，并发送一封新的邀请函，附带管理员权限：

```
javascriptCopy code
POST /api/invites/new

{"email":"attacker@somehost.com","role":"admin"}
```

稍后，攻击者使用恶意构造的邀请函创建了一个管理员帐户，并获得了对系统的完全访问权限。

### 场景 #2

API 包含一个仅应暴露给管理员的端点- `GET /api/admin/v1/users/all`。 该端点返回应用程序所有用户的详细信息，并且未实现功能级授权检查。一个了解API结构的攻击者猜测并成功访问了这个端点，泄露了应用程序用户的敏感详细信息。

## 如何预防

您的应用程序应该具有一致且易于分析的授权模块，该模块从所有业务函数中调用。通常，此类保护由应用程序代码之外的一个或多个组件提供。

- 执行机制默认应拒绝所有访问，需要为访问每个功能授予特定角色的明确授权。
- 根据应用程序的业务逻辑和组层次结构，检查 API 端点中的功能级授权缺陷。
- 确保所有管理控制器都继承自一个管理抽象控制器，该控制器基于用户的组/角色实现授权检查。
- 确保普通控制器中的管理功能实现基于用户的组和角色的授权检查。

## 参考资料

### OWASP

* [Forced Browsing][1]
* "A7: Missing Function Level Access Control", [OWASP Top 10 2013][2]
* [Access Control][3]

### External

* [CWE-285: Improper Authorization][4]

[1]: https://owasp.org/www-community/attacks/Forced_browsing
[2]: https://github.com/OWASP/Top10/raw/master/2013/OWASP%20Top%2010%20-%202013.pdf
[3]: https://owasp.org/www-community/Access_Control
[4]: https://cwe.mitre.org/data/definitions/285.html
