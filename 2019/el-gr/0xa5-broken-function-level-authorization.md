API5:2019 Broken Function Level Authorization
=============================================

| Παράγοντες Απειλής (Threat agents) / Φορείς Επίθεσης (Attack vectors) | Αδυναμία Ασφαλείας (Security Weakness) | Επιπτώσεις (Impacts) |
| - | - | - |
| Εξαρτώνται από το API : Εκμεταλλευσιμότητα **3** | Επιπολασμός **2** : Ανιχνευσιμότητα **1** | Τεχνικές Επιπτώσεις **2** : Εξαρτώνται από την Επιχείρηση |
| Η εκμετάλλευση (exploitation) απαιτεί από τον εισβολέα (attacker) να στείλει νόμιμες κλήσεις API σε τελικό σημείο API (endpoint) στο οποίο δεν πρέπει να έχει πρόσβαση. Τα τελικά σημεία αυτά ενδέχεται να εκτίθενται σε ανώνυμους χρήστες ή/και σε κανονικούς, μη προνομιούχους χρήστες (non-privileged users). Είναι εύκολο να ανακαλύψετε τέτοιου είδους ελαττώματα σε API καθώς τα API έχουν δομή και ο τρόπος πρόσβασης σε ορισμένες λειτουργίες είναι εύκολα προβλέψιμος (π.χ. αντικατάσταση της μεθόδου HTTP από GET σε PUT ή αλλαγή της συμβολοσειράς "χρήστες" στη διεύθυνση URL σε "διαχειριστές" ). | Οι έλεγχοι εξουσιοδότησης (authorization checks) για μια λειτουργία (function) ή έναν πόρο (resource) βασίζονται συνήθως πάνω σε κάποιο configuration και μερικές φορές ακόμη γίνονται και σε επίπεδο κώδικα. Η εφαρμογή των κατάλληλων και σωστών ελέγχων τίνει να είναι μια περίπλοκη εργασία, καθώς οι σύγχρονες εφαρμογές ενδέχεται να περιέχουν πολλούς τύπους ρόλων ή ομάδων και πολύπλοκη ιεραρχία χρηστών (π.χ. υποχρήστες, χρήστες με περισσότερους από έναν ρόλους). | Τα ελαττώματα αυτά επιτρέπουν στους εισβολείς να έχουν πρόσβαση σε μη εξουσιοδοτημένες λειτουργίες. Οι διοικητικές λειτουργίες (administrative functions) είναι οι βασικοί στόχοι για αυτό το είδος επίθεσης. |

## Πότε το API είναι ευάλωτο

Ο καλύτερος τρόπος για να βρείτε ζητήματα εξουσιοδότησης σε επίπεδο κατεστραμμένων συναρτήσεων (Broken Function Level Authorization) είναι να πραγματοποιήσετε μια ενδελεχή ανάλυση (deep analysis) του μηχανισμού εξουσιοδότησης (authorization mechanism). Λάβεται υπόψην σας την ιεραρχία των χρηστών, τους διαφορετικούς ρόλους ή/και τις ομάδες του συστήματος χρησιμοποιόντας τις ακόλουθες ερωτήσεις:

* Μπορεί ένας κανονικός χρήστης να έχει πρόσβαση στα τελικά σημεία διαχείρισης (administrative endpoints);
* Μπορεί ένας χρήστης να εκτελέσει ευαίσθητες ενέργειες (π.χ. δημιουργία, τροποποίηση ή διαγραφή) στις οποίες δεν θα έπρεπε να έχει πρόσβαση αλλάζοντας απλώς τη μέθοδο HTTP (π.χ. από "GET" σε "DELETE");
* Μπορεί ένας χρήστης από την ομάδα Χ να αποκτήσει πρόσβαση σε μια συνάρτηση που θα πρέπει να εκτίθεται μόνο σε χρήστες από την ομάδα Υ, μαντεύοντας απλώς τη διεύθυνση URL του τελικού σημείου και τις παραμέτρους (π.χ. `/api/v1/users/export_all`);

Μην υποθέτετε ότι ένα τελικό σημείο API είναι κανονικό ή διαχειριστικό μόνο με βάση τη διαδρομή URL.

Ενώ οι προγραμματιστές ενδέχεται να επιλέξουν να εκθέσουν τα περισσότερα από τα τελικά σημεία διαχείρισης σε μια συγκεκριμένη σχετική διαδρομή, όπως `api/admins`, είναι πολύ συνηθισμένο να βρίσκουμε αυτά τα τελικά σημεία διαχείρισης σε άλλες σχετικές διαδρομές μαζί με κανονικά τελικά σημεία, όπως `api/users`.

## Παραδείγματα Σεναρίων Επίθεσης

### Σενάριο Επίθεσης #1

Κατά τη διαδικασία εγγραφής σε μια εφαρμογή που επιτρέπει τη συμμετοχή μόνο σε 
προσκεκλημένους χρήστες, η εφαρμογή για κινητά εκτελεί μια κλήση API στο 
`GET /api/invites/{invite_guid}`. Η απάντηση περιέχει ένα JSON με λεπτομέρειες 
σχετικά με την πρόσκληση, συμπεριλαμβανομένου του ρόλου του χρήστη και του email του χρήστη.

Ένας εισβολέας αντιτύπωσε το αίτημα και άλλαξε τη μέθοδο HTTP και το τελικό 
σημείο σε `POST /api/invites/new`. Το τελικό σημείο αυτό θα πρέπει να είναι προσβάσιμο μόνο 
από διαχειριστές που χρησιμοποιούν την κονσόλα διαχειριστή, το οποίο όμως τελικό σημείο δεν εφαρμόζει ελέγχους 
εξουσιοδότησης σε επίπεδο συνάρτησης.

Ο εισβολέας εκμεταλλεύεται το πρόβλημα και στέλνει στον εαυτό του μια πρόσκληση για να δημιουργήσει έναν λογαριασμό διαχειριστή:

```
POST /api/invites/new

{“email”:”hugo@malicious.com”,”role”:”admin”}
```

### Σενάριο Επίθεσης #2

Ένα API περιέχει ένα τελικό σημείο (endpoint) που θα πρέπει να εκτίθεται μόνο στους διαχειριστές - 
`GET /api/admin/v1/users/all`. Αυτό το τελικό σημείο (endpoint) επιστρέφει τα στοιχεία όλων των χρηστών της 
εφαρμογής και δεν εφαρμόζει ελέγχους εξουσιοδότησης σε επίπεδο συνάρτησης. Ένας εισβολέας που 
έμαθε τη δομή του API κάνει μια πιθανή εικασία και καταφέρνει να αποκτήσει πρόσβαση σε αυτό 
το τελικό σημείο (endpoint), το οποίο εκθέτει ευαίσθητες λεπτομέρειες των χρηστών της εφαρμογής.



## Τρόπος Πρόληψης

Η εφαρμογή σας θα πρέπει να διαθέτει μια συνεπή και εύκολη στην ανάλυση ενότητα εξουσιοδότησης (authorization module) που θα επικαλείται από όλες τις επιχειρηματικές λειτουργίες (business functions). Συχνά, μια τέτοια προστασία παρέχεται από ένα ή περισσότερα στοιχεία (components) που βρίσκονται εκτός του κώδικα της εφαρμογής.

* Οι μηχανισμοί επιβολής θα πρέπει να απαγορεύουν κάθε πρόσβαση από προεπιλογή, απαιτώντας ρητές επιχορηγήσεις (explicit grants) σε συγκεκριμένους ρόλους για πρόσβαση σε κάθε λειτουργία.
* Ελέγξτε τα τελικά σημεία του API σας σε σχέση με ελαττώματα εξουσιοδότησης σε επίπεδο συνάρτησης (function level), λαμβάνοντας παράλληλα υπόψη την επιχειρηματική λογική (business logic) της ιεραρχίας της εφαρμογής και των ομάδων.
* Βεβαιωθείτε ότι όλοι οι διαχειριστικοί controllers σας κληρονομούν από έναν διαχειριστικό abstract controller που εφαρμόζει ελέγχους εξουσιοδότησης με βάση την ομάδα/ρόλο του χρήστη.
* Βεβαιωθείτε ότι οι λειτουργίες διαχείρισης μέσα σε έναν κανονικό controller εφαρμόζουν ελέγχους εξουσιοδότησης βάσει της ομάδας και του ρόλου του χρήστη.

## Αναφορές (References)

### Αναφορές OWASP

* [OWASP Article on Forced Browsing][1]
* [OWASP Top 10 2013-A7-Missing Function Level Access Control][2]
* [OWASP Development Guide: Chapter on Authorization][3]

### Εξωτερικές Αναφορές

* [CWE-285: Improper Authorization][4]

[1]: https://www.owasp.org/index.php/Forced_browsing
[2]: https://www.owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control
[3]: https://www.owasp.org/index.php/Category:Access_Control
[4]: https://cwe.mitre.org/data/definitions/285.html
