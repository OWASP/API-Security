API7:2019 Security Misconfiguration
===================================

| Παράγοντες Απειλής (Threat agents) / Φορείς Επίθεσης (Attack vectors) | Αδυναμία Ασφαλείας (Security Weakness) | Επιπτώσεις (Impacts) |
| - | - | - |
| Εξαρτώνται από το API : Εκμεταλλευσιμότητα **3** | Επιπολασμός **3** : Ανιχνευσιμότητα **3** | Τεχνικές Επιπτώσεις **2** : Εξαρτώνται από την Επιχείρηση |
| Οι εισβολείς συχνά επιχειρούν να βρουν μη επιδιορθωμένα ελαττώματα (unpatched flows), κοινά τελικά σημεία ή μη προστατευμένα αρχεία και καταλόγους για να αποκτήσουν μη εξουσιοδοτημένη πρόσβαση ή γνώση του συστήματος. | Λανθασμένες ρυθμίσεις παραμέτρων ασφαλείας (Security Misconfigurations) μπορούν να υπάρξουν σε οποιοδήποτε επίπεδο της στοίβας API (API stack), από το επίπεδο δικτύου έως το επίπεδο εφαρμογής. Διατίθενται αυτοματοποιημένα εργαλεία για τον εντοπισμό και την εκμετάλλευση εσφαλμένων διαμορφώσεων, όπως περιττές υπηρεσίες ή επιλογές παλαιού τύπου (legacy options). | Οι εσφαλμένες διαμορφώσεις ασφαλείας όχι μόνο εκθέτουν ευαίσθητα δεδομένα χρήστη, αλλά και λεπτομέρειες συστήματος που μπορεί να οδηγήσουν σε πλήρη παραβίαση του διακομιστή. |

## Πότε το API είναι ευάλωτο

Το API μπορεί να είναι ευάλωτο όταν:

* Δεν υπάρχει η κατάλληλη θωράκιση ασφαλείας (security hardening) σε όλα τα 
μέρη της στοίβας της εφαρμογής, ή υπάρχουν λανθασμένες ρυθμίσεις δικαιωμάτων σε υπηρεσίες Cloud. 
* Δεν έχουν εγκατασταθεί οι ενημερωμένες εκδόσεις ασφαλείας, ή τα συστήματα είναι παροχημένα.
* Αχρείαστα χαρακτηριστικά (features) είναι ενεργοποιημένα (για παράδειγμα, το API δέχεται HTTP verbs που δεν χρησιμοποιούνται).
* Δεν υπάρχει Transport Layer Security (TLS).
* Δεν στέλνονται στους clients οι οδηγίες ασφαλείας (security directives)(e.g., [Επικεφαλίδες Ασφαλείας][1]).
* Δεν υπάρχει πολιτική Cross-Origin Resource Sharing (CORS) ή έχει ρυθμιστεί εσφαλμένα.
* Τα μηνύματα σφαλμάτων περιλαμβάνουν το ίχνος στοίβας (stack trace) ή άλλες ευαίσθητες πληροφορίες είναι εκτεθειμένες.

## Παραδείγματα από Σενάρια Επίθεσης

### Σενάριο #1

Ένας εισβολέας βρίσκει το αρχείο `.bash_history` κάτω από τον κεντρικό φάκελο (root folder)
του διακομιστή, το οποίο περιλαμβάνει εντολές που χρησιμοποιήθηκαν από την ομάδα DevOps για να έχει πρόσβαση στο API:

```
$ curl -X GET 'https://api.server/endpoint/' -H 'authorization: Basic Zm9vOmJhcg=='
```

Ένας εισβολέας θα μπορούσε επίσης να βρει άγνωστα τελικά σημεία του API που
χρησιμοποιούνται μόνο απο την ομάδα DevOps και τα οποία δεν είναι τεκμηριωμένα.

### Σενάριο #2

Με στόχο μια συγκεκριμένη υπηρεσία, ένας εισβολέας χρησιμοποιεί μια δημοφιλή μηχανή αναζήτησης για να αναζητήσει
υπολογιστές άμεσα προσβάσιμους από το Διαδίκτυο. Ο εισβολέας βρίσκει έναν διακομιστή που τρέχει ένα δημοφιλές σύστημα
διαχείρισης βάσεων δεδομένων, το οποίο ακούει στην προεπιλεγμένη θύρα.
Ο διακομιστής αυτός χρησιμοποιεί τις προεπιλεγμένες ρυθμίσεις (default configuration), οι οποίες έχουν απενεργοποιημένο
τον έλεγχο ταυτότητας, με αποτέλεσμα ο εισβολέας να αποκτήσει πρόσβαση σε εκατομμύρια εγγραφές με προσωπικά δεδομένα (PII),
προσωπικές προτιμήσεις και δεδομένα ελέγχου ταυτότητας.

### Σενάριο #3

Επιθεωρώντας την κίνηση δεδομένων μιας εφαρμογής για κινητά, 
ένας εισβολέας ανακαλύπτει ότι η κίνηση HTTP δεν εκτελείται ολικά κάτω από ένα ασφαλές πρωτόκολλο (π.χ. TLS).
Ο εισβολέας ανακαλύπτει ότι αυτό συμβαίνει ειδικά για τη λήψη εικόνων προφίλ. 
Καθώς η αλληλεπίδραση του χρήστη είναι δυαδική και παρά το γεγονός ότι η υπόλοιπη κίνηση API εκτελείται κάτω από ένα ασφαλές πρωτόκολλο, 
ο εισβολέας βρίσκει ένα μοτίβο στο μέγεθος των απαντήσεων API, 
το οποίο χρησιμοποιεί για να παρακολουθεί τις προτιμήσεις των χρηστών σε σχέση με το περιεχόμενο που εμφανίζεται (π.χ. εικόνες προφίλ).

## Τρόπος Πρόληψης

Με στόχο την αποτελεσματική πρόληψη, ο κύκλος ζωής των API θα πρέπει να περιλαμβάνει τα παρακάτω:

* Επαναλαμβανόμενη διαδικασία θωράκισης (hardening) που επιτρέπει γρήγορη 
και εύκολη εγκατάσταση ενός σωστά ασφαλισμένου περιβάλλοντος στο οποίο θα τρέχουν τα API.
*  Έλεγχο και ενημέρωση των ρυθμίσεων σε ολόκληρο το stack των API. Ο έλεγχος θα πρέπει να περιλαμβάνει αρχεία που χρησιμοποιούνται κατά την ενορχήστρωση (orchestration), API components και υπηρεσίες cloud (π.χ. δικαιώματα κάδων S3).
* Ένα ασφαλές κανάλι επικοινωνίας για όλες τις αλληλεπιδράσεις του API σε στατικά στοιχεία (π.χ. εικόνες).
* Αυτοματοποιημένη διαδικασία για τη συνεχή αξιολόγηση της αποτελεσματικότητας των ρυθμίσεων σε όλα τα περιβάλλοντα.

Ακόμα:

* Για να αποτρέψετε την πιθανή αποστολή ίχνων εξαίρεσης (exception trace) και άλλων πολύτιμων πληροφοριών στους εισβολείς,
εάν έχετε την δυνατότητα, ορίστε και επιβάλετε συγκρεκριμένα σχήματα απόκρισης API, συμπεριλαμβανομένων των αποκρίσεων σφαλμάτων.
* Βεβαιωθείτε ότι το API είναι προσβάσιμο μόνο από τα ρήματα HTTP (HTTP verbs) που έχετε καθορίσει. 
Όλα τα άλλα ρήματα HTTP (HTTP verbs) θα πρέπει να είναι απενεργοποιημένα (π.χ. "HEAD").
* Τα API που αναμένεται να έχουν πρόσβαση από πελάτες που βασίζονται σε προγράμματα περιήγησης 
* (π.χ., το front-end μιας εφαρμογής Web) θα πρέπει να εφαρμόζουν μια σωστή πολιτική κοινής χρήσης πόρων μεταξύ προέλευσης (CORS).

## Αναφορές (References)

### Αναφορές OWASP

* [OWASP Secure Headers Project][1]
* [OWASP Testing Guide: Configuration Management][2]
* [OWASP Testing Guide: Testing for Error Codes][3]
* [OWASP Testing Guide: Test Cross Origin Resource Sharing][9]

### Εξωτερικές Αναφορές

* [CWE-2: Environmental Security Flaws][4]
* [CWE-16: Configuration][5]
* [CWE-388: Error Handling][6]
* [Guide to General Server Security][7], NIST
* [Let’s Encrypt: a free, automated, and open Certificate Authority][8]

[1]: https://www.owasp.org/index.php/OWASP_Secure_Headers_Project
[2]: https://www.owasp.org/index.php/Testing_for_configuration_management
[3]: https://www.owasp.org/index.php/Testing_for_Error_Code_(OTG-ERR-001)
[4]: https://cwe.mitre.org/data/definitions/2.html
[5]: https://cwe.mitre.org/data/definitions/16.html
[6]: https://cwe.mitre.org/data/definitions/388.html
[7]: https://csrc.nist.gov/publications/detail/sp/800-123/final
[8]: https://letsencrypt.org/
[9]: https://www.owasp.org/index.php/Test_Cross_Origin_Resource_Sharing_(OTG-CLIENT-007)
